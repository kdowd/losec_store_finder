function islocal(){return-1!==location.host.indexOf("127.0.0.1")}function loadScript(e){var t=document.getElementsByTagName("head")[0],o=document.createElement("script");o.src=e,o.setAttribute("async",""),o.onload=function(e){console.log("gmap script loaded ")},t.append(o)}function get_my_marker(){return svgMarker={path:"M10.453 14.016l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM12 2.016q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",fillColor:"blue",fillOpacity:1,strokeWeight:1,strokeColor:"white",rotation:0,scale:2,anchor:new google.maps.Point(15,30)}}class StoreMaps{constructor(e){console.log("map class is go !!"),this.element=e,this.latlng=new google.maps.LatLng(-41.326417,174.7970903),this.myOptions={zoom:6,tilt:0,center:this.latlng,navigationControl:!1,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,scrollwheel:!1,disableDoubleClickZoom:!0,disableDefaultUI:!1,mapTypeId:google.maps.MapTypeId.ROADMAP},document.addEventListener("onLocationFound",this.updateLocation),document.addEventListener("onCenterStore",this.centerStore),document.addEventListener("onCurrentLocation",this.updateToUserLocation)}updateToUserLocation=e=>{this.goToLatLon({lat:e.detail.geo.lat,lng:e.detail.geo.lng})};updateLocation=e=>{this.goToLatLon(e.detail.results[0].geometry.location)};centerStore=e=>{e=new google.maps.LatLng(e.detail.lat,e.detail.lng);this.map.setZoom(18),this.map.setCenter(e)};showMap(){this.map=new google.maps.Map(this.element,this.myOptions)}getMap(){return this.map}goToLatLon(e){e=new google.maps.LatLng(e.lat,e.lng);console.log(this.map.getZoom()),12===this.map.getZoom()?this.map.panTo(e):(this.map.setZoom(12),this.map.setCenter(e))}showMarkers(t){for(var o=0;o<t.length;o++){var s=new google.maps.LatLng(t[o].latitude,t[o].longitude);let e=new google.maps.Marker({position:s,map:this.map,title:t[o]["Pharmacy Name"],draggable:!1});s="<strong>"+t[o].name+"</strong>";s+="<strong>"+t[o].address+"</strong>",s+="<strong>"+t[o].city+"</strong>",e.info=new google.maps.InfoWindow({content:s}),google.maps.event.addListener(e,"click",function(){e.info.open(this.map,e)})}}}class Style{mapStyle(){return[{stylers:[{saturation:-100},{saturation:-100}]},{featureType:"road",elementType:"geometry",stylers:[{lightness:50},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]}]}}class NoLocationResult{constructor(){document.addEventListener("onLocationFound",this.reset),document.addEventListener("onNoLocationFound",this.updateUser),this.resultElement}reset=()=>{console.log("reset updateUser"),this.resultElement.classList.replace("show-result","hide-result")};updateUser=()=>{console.log("onNoLocationFound"),this.resultElement.classList.replace("hide-result","show-result")};get resultElement(){return this._resultElement}set resultElement(e){this._resultElement=e}}class LocationSearch{constructor(e){console.log("new location search.. " ),this.address=encodeURIComponent(e + " NZ")}geocodeAddress(){var e=`https://maps.googleapis.com/maps/api/geocode/json?address=${this.address}&region=nz&key=AIzaSyC-du7rwYlXpEhaqDKn29XXT2NwKg-Q2HU`;fetch(e).then(e=>e.json()).then(e=>{var t;return console.log(e),"OK"===e.status&&(t=new CustomEvent("onLocationFound",{bubbles:!0,detail:e}),document.dispatchEvent(t)),e}).then(e=>{"ZERO_RESULTS"===e.status&&(e=new CustomEvent("onNoLocationFound",{bubbles:!0,detail:e}),document.dispatchEvent(e))}).catch(e=>{console.error("Error:",e)})}geocodeAddress_old(){(new google.maps.Geocoder).geocode({componentRestrictions:{country:"NZ"},address:this.address},(e,t)=>{"OK"===t?console.log(e):alert("Geocode was not successful for the following reason: "+t)})}}class FindNearestStores{constructor(){console.log("FindNearestStores class is go !!"),this.data=null,document.addEventListener("onLocationFound",this.lookForClosestStores),document.addEventListener("onCurrentLocation",this.lookForClosestStores),this.maxStores=3}get maxStores(){return this._maxStores}set maxStores(e){this._maxStores=Math.max(0,e)}lookForClosestStores=e=>{let s=e.detail.results?e.detail.results[0].geometry.location:e.detail.geo;this.data.forEach((e,t)=>{var o={lat:e.latitude,lng:e.longitude},o=this.haversine_distance(s,o);e.distance=o}),this.sortByDistance(),this.showUserResults()};showUserResults(){let e=this.data.slice(0,this.maxStores);(new Store).removeAllChildNodes(),Store.counter=0,e.forEach((e,t)=>{(new Store).updateStores(e)})}getResultsDiv(e,t){let o=document.createElement("div");t=document.createTextNode(e+" "+t.toFixed(2));return o.appendChild(t),o}sortByDistance(){this.data.sort(function(e,t){return e.distance-t.distance})}get data(){return this._data}set data(e){this._data=e}haversine_distance(e,t){var o=e.lat*(Math.PI/180),s=t.lat*(Math.PI/180),n=s-o,e=(t.lng-e.lng)*(Math.PI/180);return 7917.6*Math.asin(Math.sqrt(Math.sin(n/2)*Math.sin(n/2)+Math.cos(o)*Math.cos(s)*Math.sin(e/2)*Math.sin(e/2)))}}class Store{static counter=0;constructor(){let e=document.querySelector(".cloned");this.clonedElement=e.cloneNode(!0),this.targetElement=document.querySelector(".closest-stores"),this.clonedElement.addEventListener("click",e=>{var t=new CustomEvent("onCenterStore",{bubbles:!0,detail:{lat:this.lat,lng:this.lng}});document.dispatchEvent(t)})}removeAllChildNodes=e=>{for(;this.targetElement.hasChildNodes();)this.targetElement.removeChild(this.targetElement.lastChild)};updateStores=e=>{var t=++Store.counter;this.clonedElement.setAttribute("style",`animation-name:fadeInDown; animation-duration: 100ms; animation-delay:${100*t}ms`),this.lat=e.latitude,this.lng=e.longitude,this.clonedElement.querySelector("span").innerText=t,this.clonedElement.querySelector(".storeName").innerText=e.name,this.clonedElement.querySelector(".storeAddress").innerText=e.address,this.clonedElement.querySelector(".distance").innerText=e.distance.toFixed(2)+" km",this.targetElement.appendChild(this.clonedElement)}}class LocationRequest{constructor(){this.delay=5e3,this.timeout=setTimeout(this.onTimedOut,this.delay)}onTimedOut=e=>{console.log("onTimedOut, show user message.")};showNoLocationMessage=()=>{let e=document.querySelector(".location-blocked");e&&(e.style.display="flex")};onKillTimeout=()=>{clearTimeout(this.timeout)};makeRequest=e=>{navigator.geolocation.getCurrentPosition(this.onSuccess,this.onFail)};onSuccess=e=>{this.onKillTimeout();e=new CustomEvent("onCurrentLocation",{bubbles:!0,detail:{geo:{lat:e.coords.latitude,lng:e.coords.longitude}}});document.dispatchEvent(e)};onFail=e=>{console.log(e.message),this.showNoLocationMessage()};onStore=e=>{var t=JSON.stringify(Object.values(e)[0]);e&&0<t.length&&window.localStorage.setItem(Object.keys(e)[0],JSON.stringify(Object.values(e)[0]))}}function debounce(t,o=250){let s;return(...e)=>{clearTimeout(s),s=setTimeout(()=>{t.apply(this,e)},o)}}function updateParent(){var e=document.body.getBoundingClientRect(),e={width:e.width,height:e.height};window.parent.postMessage(JSON.stringify(e),"https://www.losecextra.co.nz/where-buy"),console.log("iframe wxh = ",e)}const debouncer=debounce(()=>updateParent());window.addEventListener("resize",debouncer);const key="AIzaSyC-du7rwYlXpEhaqDKn29XXT2NwKg-Q2HU",libs="&libraries=places";function loadStoresJSON(){fetch("./unichemdata.json").then(e=>e.json()).then(e=>window.locationsJSON=e).then(()=>{setTimeout(function(){navigator.onLine&&loadScript(`//maps.googleapis.com/maps/api/js?key=${key+libs}&callback=initMap`)}.bind(this),500)})}function killLoader(){let e=document.querySelector(".svg-loader");e&&(e.style.display="none")}function killNoLocationMessage(){let e=document.querySelector(".location-blocked");e&&(e.style.display="none")}function initMap(){killLoader();let e=new StoreMaps(document.querySelector(".map-container "));e.showMap(),e.showMarkers(window.locationsJSON),(new LocationRequest).makeRequest();let t=new NoLocationResult;t.resultElement=document.querySelector(".no-location-result");let o=new FindNearestStores;o.maxStores=5,o.data=window.locationsJSON}function onLocationSearch(e){e.preventDefault();e=e.target.elements[0].value;2<(e=e.trim()).length&&new LocationSearch(e).geocodeAddress(),killNoLocationMessage()}window.addEventListener("DOMContentLoaded",e=>{loadStoresJSON()},!1);
